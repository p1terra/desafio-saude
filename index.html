<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Desafio da SaÃºde Online</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <!-- Bibliotecas para exportaÃ§Ã£o -->
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  body { font-family: 'Inter', sans-serif; }
Â  Â  Â  Â  .hidden { display: none; }
Â  Â  Â  Â  .loader {
Â  Â  Â  Â  Â  Â  border: 4px solid #f3f3f3;
Â  Â  Â  Â  Â  Â  border-top: 4px solid #3498db;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 40px;
Â  Â  Â  Â  Â  Â  height: 40px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-select {
Â  Â  Â  Â  Â  Â  -webkit-appearance: none; -moz-appearance: none; appearance: none;
Â  Â  Â  Â  Â  Â  background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E');
Â  Â  Â  Â  Â  Â  background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 0.65rem auto;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-50 text-gray-800">

Â  Â  <div id="app-container" class="container mx-auto p-4 sm:p-6 max-w-5xl">
Â  Â  Â  Â  <!-- TELA DE LOADING INICIAL -->
Â  Â  Â  Â  <div id="loading-screen" class="text-center p-10">
Â  Â  Â  Â  Â  Â  <div class="loader mx-auto"></div>
Â  Â  Â  Â  Â  Â  <p class="mt-4 text-gray-600">A ligar ao servidor...</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- TELA DE CONFIGURAÃ‡ÃƒO INICIAL -->
Â  Â  Â  Â  <div id="setup-screen" class="hidden">
Â  Â  Â  Â  Â  Â  <header class="text-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl sm:text-4xl font-bold text-teal-600">Desafio da SaÃºde</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 mt-1">Selecione a data e o participante para comeÃ§ar.</p>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-md max-w-md mx-auto space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="setup-date" class="block text-sm font-medium text-gray-700 mb-1">Data do Check-in:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="setup-date" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="setup-participant" class="block text-sm font-medium text-gray-700 mb-1">Participante:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="setup-participant" class="custom-select w-full p-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Selecione --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="confirmation-details" class="hidden text-center bg-gray-100 p-3 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Registar para <strong id="confirm-name"></strong> no dia <strong id="confirm-date"></strong>.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="confirm-setup-btn" disabled class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200">Confirmar e Continuar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- TELA PRINCIPAL DO APP (Check-in e Ranking) -->
Â  Â  Â  Â  <div id="main-app" class="hidden">
Â  Â  Â  Â  Â  Â  <header class="text-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â <h1 class="text-3xl sm:text-4xl font-bold text-teal-600">Check-in</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-gray-500 mt-1">Participante: <strong id="current-participant-name"></strong> | Data: <strong id="current-checkin-date"></strong></p>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  Â <div id="message-box" class="hidden text-center p-3 mb-6 rounded-lg"></div>

Â  Â  Â  Â  Â  Â  <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Coluna de FormulÃ¡rios -->
Â  Â  Â  Â  Â  Â  Â  Â  <form id="checkin-form" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Atividade FÃ­sica -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 border-b pb-2">1. Atividade FÃ­sica</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="aerobic-minutes" class="block text-sm font-medium">1.1 Minutos de atividade aerÃ³bica hoje:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="aerobic-minutes" min="0" placeholder="Ex: 30" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="strength-sessions" class="block text-sm font-medium">1.2 SessÃµes de forÃ§a hoje:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="strength-sessions" min="0" max="2" placeholder="Ex: 1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- AlimentaÃ§Ã£o -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 border-b pb-2">2. AlimentaÃ§Ã£o</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium">2.1 RefeiÃ§Ãµes com frutas/vegetais:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="fruit-checklist" class="mt-2 grid grid-cols-2 gap-2 text-sm"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium">Outras metas de alimentaÃ§Ã£o:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 space-y-2 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center"><input id="hydration" type="checkbox" class="h-4 w-4 rounded border-gray-300"><label for="hydration" class="ml-2">2.2 Bebi 2L+ de Ã¡gua</label></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center"><input id="no-sweets" type="checkbox" class="h-4 w-4 rounded border-gray-300"><label for="no-sweets" class="ml-2">2.3 Sem doces/refris/fast-food</label></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Bem-Estar e Sono -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 border-b pb-2">3. Bem-Estar e Sono</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center text-sm"><input id="sleep" type="checkbox" class="h-4 w-4 rounded border-gray-300"><label for="sleep" class="ml-2">3.1 Dormi 7h+ de sono</label></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium">3.2 Atividades de bem-estar (marque as realizadas na semana):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="selfcare-checklist" class="mt-2 grid grid-cols-2 gap-2 text-sm"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="submit-checkin-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors duration-200">Finalizar Check-in</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Coluna do Ranking -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4">Ranking Geral</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3" id="leaderboard"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- TELA DE RESUMO (MODAL) -->
Â  Â  Â  Â  <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="summary-content" class="p-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-center text-teal-600 mb-2">Resumo do Check-in</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-gray-600 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong id="summary-name"></strong> - <span id="summary-date"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PontuaÃ§Ãµes detalhadas -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="summary-details" class="bg-gray-50 p-4 rounded-lg"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Totais -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-teal-100 p-2 rounded"><div class="font-bold text-lg text-teal-800" id="summary-daily-total"></div><div class="text-xs text-teal-700">Pontos do Dia</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-blue-100 p-2 rounded"><div class="font-bold text-lg text-blue-800" id="summary-weekly-total"></div><div class="text-xs text-blue-700">Total na Semana</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-indigo-100 p-2 rounded"><div class="font-bold text-lg text-indigo-800" id="summary-monthly-total"></div><div class="text-xs text-indigo-700">Total no MÃªs</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-purple-100 p-2 rounded"><div class="font-bold text-lg text-purple-800" id="summary-general-total"></div><div class="text-xs text-purple-700">PontuaÃ§Ã£o Geral</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Progresso semanal -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="summary-progress" class="bg-gray-50 p-4 rounded-lg"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-gray-100 rounded-b-xl flex flex-col sm:flex-row gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-png-btn" class="flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Exportar Imagem (.png)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-xls-btn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Exportar Planilha (.xls)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="close-summary-btn" class="flex-1 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Voltar ao InÃ­cio</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  // --- IMPORTAÃ‡Ã•ES DO FIREBASE ---
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

Â  Â  Â  Â  // --- CONFIGURAÃ‡ÃƒO INICIAL ---
Â  Â  Â  Â  const participants = ['Carol', 'IagÃª', 'Juliana', 'Mariana', 'Radmila'];
Â  Â  Â  Â  const challengeStartDate = new Date('2025-08-25T00:00:00');
Â  Â  Â  Â  const MEALS = ['CafÃ© da manhÃ£', 'Lanche da manhÃ£', 'AlmoÃ§o', 'Lanche da tarde', 'Jantar', 'Ceia'];
Â  Â  Â  Â  const SELFCARE_ACTIVITIES = ['MeditaÃ§Ã£o', 'Alongamento', 'Caminhada na natureza', 'Ler um livro', 'Outras'];

Â  Â  Â  Â  let state = {
Â  Â  Â  Â  Â  Â  selectedParticipant: null,
Â  Â  Â  Â  Â  Â  selectedDate: null,
Â  Â  Â  Â  Â  Â  allData: {}, // Armazena todos os dados de todos os participantes
Â  Â  Â  Â  Â  Â  db: null,
Â  Â  Â  Â  Â  Â  appId: typeof __app_id !== 'undefined' ? __app_id : 'default-health-challenge'
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- ELEMENTOS DO DOM ---
Â  Â  Â  Â  const loadingScreen = document.getElementById('loading-screen');
Â  Â  Â  Â  const setupScreen = document.getElementById('setup-screen');
Â  Â  Â  Â  const mainApp = document.getElementById('main-app');
Â  Â  Â  Â  const setupDate = document.getElementById('setup-date');
Â  Â  Â  Â  const setupParticipant = document.getElementById('setup-participant');
Â  Â  Â  Â  const confirmDetails = document.getElementById('confirmation-details');
Â  Â  Â  Â  const confirmName = document.getElementById('confirm-name');
Â  Â  Â  Â  const confirmDate = document.getElementById('confirm-date');
Â  Â  Â  Â  const confirmBtn = document.getElementById('confirm-setup-btn');
Â  Â  Â  Â  const checkinForm = document.getElementById('checkin-form');
Â  Â  Â  Â  const leaderboardContainer = document.getElementById('leaderboard');
Â  Â  Â  Â  const summaryModal = document.getElementById('summary-modal');
Â  Â  Â  Â  const messageBox = document.getElementById('message-box');

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE PONTUAÃ‡ÃƒO ---
Â  Â  Â  Â  const getAerobicScore = (minutes) => {
Â  Â  Â  Â  Â  Â  if (minutes >= 130) return 20; if (minutes >= 100) return 14; if (minutes >= 80) return 12;
Â  Â  Â  Â  Â  Â  if (minutes >= 60) return 10; if (minutes >= 40) return 8; if (minutes >= 20) return 4;
Â  Â  Â  Â  Â  Â  if (minutes > 0) return 2; return 0;
Â  Â  Â  Â  };
Â  Â  Â  Â  const getStrengthScore = (sessions) => {
Â  Â  Â  Â  Â  Â  if (sessions >= 2) return 10; if (sessions >= 1) return 2; return 0;
Â  Â  Â  Â  };
Â  Â  Â  Â  const getFruitScore = (portions) => {
Â  Â  Â  Â  Â  Â  if (portions >= 5) return 10; if (portions >= 4) return 6; if (portions >= 3) return 3;
Â  Â  Â  Â  Â  Â  if (portions >= 2) return 2; if (portions >= 1) return 1; return 0;
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE DATA ---
Â  Â  Â  Â  const getFormattedDateKey = (d) => d.toISOString().split('T')[0];
Â  Â  Â  Â  const getChallengeWeekKey = (d) => {
Â  Â  Â  Â  Â  Â  if (d < challengeStartDate) return null;
Â  Â  Â  Â  Â  Â  const diffTime = d - challengeStartDate;
Â  Â  Â  Â  Â  Â  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  return `challenge-week-${Math.floor(diffDays / 7)}`;
Â  Â  Â  Â  };
Â  Â  Â  Â  const getMonthKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE UI ---
Â  Â  Â  Â  const showMessage = (message, type = 'success') => {
Â  Â  Â  Â  Â  Â  messageBox.textContent = message;
Â  Â  Â  Â  Â  Â  messageBox.className = `text-center p-3 mb-6 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
Â  Â  Â  Â  Â  Â  setTimeout(() => messageBox.className = 'hidden', 3000);
Â  Â  Â  Â  };

Â  Â  Â  Â  const populateChecklists = () => {
Â  Â  Â  Â  Â  Â  const fruitContainer = document.getElementById('fruit-checklist');
Â  Â  Â  Â  Â  Â  fruitContainer.innerHTML = MEALS.map(meal => `<div class="flex items-center"><input type="checkbox" id="fruit-${meal.replace(/\s/g, '')}" name="fruit-meal" value="${meal}" class="h-4 w-4 rounded border-gray-300"><label for="fruit-${meal.replace(/\s/g, '')}" class="ml-2">${meal}</label></div>`).join('');
Â  Â  Â  Â  Â  Â  const selfcareContainer = document.getElementById('selfcare-checklist');
Â  Â  Â  Â  Â  Â  selfcareContainer.innerHTML = SELFCARE_ACTIVITIES.map(activity => `<div class="flex items-center"><input type="checkbox" id="selfcare-${activity.replace(/\s/g, '')}" name="selfcare-activity" value="${activity}" class="h-4 w-4 rounded border-gray-300"><label for="selfcare-${activity.replace(/\s/g, '')}" class="ml-2">${activity}</label></div>`).join('');
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- LÃ“GICA DE CÃLCULO GERAL ---
Â  Â  Â  Â  const calculateAllScores = (participantName) => {
Â  Â  Â  Â  Â  Â  const participantData = state.allData[participantName] || { dailyLogs: {} };
Â  Â  Â  Â  Â  Â  const scores = { total: 0, weekly: 0, monthly: 0 };
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  const currentWeekKey = getChallengeWeekKey(today);
Â  Â  Â  Â  Â  Â  const currentMonthKey = getMonthKey(today);
Â  Â  Â  Â  Â  Â  const weeklyAggregates = {};

Â  Â  Â  Â  Â  Â  for (const dateKey in participantData.dailyLogs) {
Â  Â  Â  Â  Â  Â  Â  Â  const logDate = new Date(dateKey + 'T12:00:00');
Â  Â  Â  Â  Â  Â  Â  Â  const weekKey = getChallengeWeekKey(logDate);
Â  Â  Â  Â  Â  Â  Â  Â  if (!weekKey) continue;
Â  Â  Â  Â  Â  Â  Â  Â  if (!weeklyAggregates[weekKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weeklyAggregates[weekKey] = { aerobicMinutes: 0, strengthSessions: 0, selfCareDone: false, dailyPoints: 0, month: getMonthKey(logDate) };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const inputs = participantData.dailyLogs[dateKey].inputs;
Â  Â  Â  Â  Â  Â  Â  Â  weeklyAggregates[weekKey].aerobicMinutes += inputs.aerobicMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  weeklyAggregates[weekKey].strengthSessions += inputs.strengthSessions;
Â  Â  Â  Â  Â  Â  Â  Â  if (inputs.selfCareActivities.length > 0) weeklyAggregates[weekKey].selfCareDone = true;
Â  Â  Â  Â  Â  Â  Â  Â  weeklyAggregates[weekKey].dailyPoints += getFruitScore(inputs.fruitPortions) + (inputs.hydration ? 5 : 0) + (inputs.noSweets ? 2 : 0) + (inputs.sleep ? 5 : 0);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  for (const weekKey in weeklyAggregates) {
Â  Â  Â  Â  Â  Â  Â  Â  const weekData = weeklyAggregates[weekKey];
Â  Â  Â  Â  Â  Â  Â  Â  const weekScore = getAerobicScore(weekData.aerobicMinutes) + getStrengthScore(weekData.strengthSessions) + (weekData.selfCareDone ? 10 : 0) + weekData.dailyPoints;
Â  Â  Â  Â  Â  Â  Â  Â  scores.total += weekScore;
Â  Â  Â  Â  Â  Â  Â  Â  if (weekKey === currentWeekKey) scores.weekly = weekScore;
Â  Â  Â  Â  Â  Â  Â  Â  if (weekData.month === currentMonthKey) scores.monthly += weekScore;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return { name: participantName, ...scores };
Â  Â  Â  Â  };

Â  Â  Â  Â  const updateLeaderboardUI = () => {
Â  Â  Â  Â  Â  Â  const allScores = participants.map(calculateAllScores).sort((a, b) => b.total - a.total);
Â  Â  Â  Â  Â  Â  leaderboardContainer.innerHTML = allScores.map((score, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const medal = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][index] || 'ðŸ”¹';
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border"><div class="flex items-center"><span class="text-xl w-8">${medal}</span><span class="font-bold">${score.name}</span></div><div class="text-right"><div class="text-lg font-bold text-teal-600">${score.total} <span class="text-xs font-normal">Total</span></div><div class="text-xs text-gray-500">Semana: ${score.weekly} | MÃªs: ${score.monthly}</div></div></div>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- LÃ“GICA DO RESUMO ---
Â  Â  Â  Â  const showSummary = () => {
Â  Â  Â  Â  Â  Â  const { selectedParticipant, selectedDate } = state;
Â  Â  Â  Â  Â  Â  const dateKey = getFormattedDateKey(selectedDate);
Â  Â  Â  Â  Â  Â  const weekKey = getChallengeWeekKey(selectedDate);
Â  Â  Â  Â  Â  Â  const allScores = calculateAllScores(selectedParticipant);
Â  Â  Â  Â  Â  Â  const dailyInputs = state.allData[selectedParticipant].dailyLogs[dateKey].inputs;

Â  Â  Â  Â  Â  Â  const dailyFruitPts = getFruitScore(dailyInputs.fruitPortions);
Â  Â  Â  Â  Â  Â  const dailyHydrationPts = dailyInputs.hydration ? 5 : 0;
Â  Â  Â  Â  Â  Â  const dailyNoSweetsPts = dailyInputs.noSweets ? 2 : 0;
Â  Â  Â  Â  Â  Â  const dailySleepPts = dailyInputs.sleep ? 5 : 0;
Â  Â  Â  Â  Â  Â  const dailyTotal = dailyFruitPts + dailyHydrationPts + dailyNoSweetsPts + dailySleepPts;

Â  Â  Â  Â  Â  Â  let weekAerobicMinutes = 0, weekStrengthSessions = 0, weekSelfCareDone = false;
Â  Â  Â  Â  Â  Â  for (const dKey in state.allData[selectedParticipant].dailyLogs) {
Â  Â  Â  Â  Â  Â  Â  Â  if (getChallengeWeekKey(new Date(dKey + 'T12:00:00')) === weekKey) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const log = state.allData[selectedParticipant].dailyLogs[dKey].inputs;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weekAerobicMinutes += log.aerobicMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weekStrengthSessions += log.strengthSessions;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.selfCareActivities.length > 0) weekSelfCareDone = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('summary-name').textContent = selectedParticipant;
Â  Â  Â  Â  Â  Â  document.getElementById('summary-date').textContent = selectedDate.toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  document.getElementById('summary-daily-total').textContent = dailyTotal;
Â  Â  Â  Â  Â  Â  document.getElementById('summary-weekly-total').textContent = allScores.weekly;
Â  Â  Â  Â  Â  Â  document.getElementById('summary-monthly-total').textContent = allScores.monthly;
Â  Â  Â  Â  Â  Â  document.getElementById('summary-general-total').textContent = allScores.total;

Â  Â  Â  Â  Â  Â  document.getElementById('summary-details').innerHTML = `<h3 class="font-bold mb-2 text-gray-700">Pontos do dia (${dailyTotal} pts):</h3><ul class="list-disc list-inside space-y-1"><li>Frutas/Vegetais: ${dailyFruitPts} pts (${dailyInputs.fruitPortions} porÃ§Ãµes)</li><li>HidrataÃ§Ã£o: ${dailyHydrationPts} pts</li><li>Sem Doces: ${dailyNoSweetsPts} pts</li><li>Sono: ${dailySleepPts} pts</li></ul>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const aerobicNeeded = Math.max(0, 150 - weekAerobicMinutes);
Â  Â  Â  Â  Â  Â  const strengthNeeded = Math.max(0, 2 - weekStrengthSessions);
Â  Â  Â  Â  Â  Â  document.getElementById('summary-progress').innerHTML = `<h3 class="font-bold mb-2 text-gray-700">Progresso na Semana:</h3><ul class="list-disc list-inside space-y-1"><li>AerÃ³bico: ${weekAerobicMinutes} min (Faltam ${aerobicNeeded} min para meta mÃ¡xima)</li><li>ForÃ§a: ${weekStrengthSessions} sessÃµes (Faltam ${strengthNeeded} para meta mÃ¡xima)</li><li>Bem-estar: ${weekSelfCareDone ? 'Meta cumprida' : 'Pendente'}</li></ul>`;

Â  Â  Â  Â  Â  Â  summaryModal.classList.remove('hidden');
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- LÃ“GICA DE EXPORTAÃ‡ÃƒO ---
Â  Â  Â  Â  document.getElementById('export-png-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  html2canvas(document.getElementById('summary-content'), { scale: 2 }).then(canvas => {
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  link.download = `resumo_${state.selectedParticipant}_${getFormattedDateKey(state.selectedDate)}.png`;
Â  Â  Â  Â  Â  Â  Â  Â  link.href = canvas.toDataURL();
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById('export-xls-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const { selectedParticipant, selectedDate } = state;
Â  Â  Â  Â  Â  Â  const allScores = calculateAllScores(selectedParticipant);
Â  Â  Â  Â  Â  Â  const dailyInputs = state.allData[selectedParticipant].dailyLogs[getFormattedDateKey(selectedDate)].inputs;
Â  Â  Â  Â  Â  Â  const dailyTotal = getFruitScore(dailyInputs.fruitPortions) + (dailyInputs.hydration ? 5 : 0) + (dailyInputs.noSweets ? 2 : 0) + (dailyInputs.sleep ? 5 : 0);

Â  Â  Â  Â  Â  Â  const data = [
Â  Â  Â  Â  Â  Â  Â  Â  ["Desafio da SaÃºde - Resumo Detalhado"],
Â  Â  Â  Â  Â  Â  Â  Â  ["Participante", selectedParticipant], ["Data", selectedDate.toLocaleDateString('pt-BR')],
Â  Â  Â  Â  Â  Â  Â  Â  [],
Â  Â  Â  Â  Â  Â  Â  Â  ["Categoria", "Valor", "Pontos"],
Â  Â  Â  Â  Â  Â  Â  Â  ["Minutos AerÃ³bicos (dia)", dailyInputs.aerobicMinutes, "-"],
Â  Â  Â  Â  Â  Â  Â  Â  ["SessÃµes de ForÃ§a (dia)", dailyInputs.strengthSessions, "-"],
Â  Â  Â  Â  Â  Â  Â  Â  ["PorÃ§Ãµes Frutas/Vegetais", dailyInputs.fruitPortions, getFruitScore(dailyInputs.fruitPortions)],
Â  Â  Â  Â  Â  Â  Â  Â  ["HidrataÃ§Ã£o (2L+)", dailyInputs.hydration ? "Sim" : "NÃ£o", dailyInputs.hydration ? 5 : 0],
Â  Â  Â  Â  Â  Â  Â  Â  ["Sem Doces/etc", dailyInputs.noSweets ? "Sim" : "NÃ£o", dailyInputs.noSweets ? 2 : 0],
Â  Â  Â  Â  Â  Â  Â  Â  ["Sono (7h+)", dailyInputs.sleep ? "Sim" : "NÃ£o", dailyInputs.sleep ? 5 : 0],
Â  Â  Â  Â  Â  Â  Â  Â  [],
Â  Â  Â  Â  Â  Â  Â  Â  ["Resumo de Pontos"],
Â  Â  Â  Â  Â  Â  Â  Â  ["PontuaÃ§Ã£o do Dia", dailyTotal],
Â  Â  Â  Â  Â  Â  Â  Â  ["PontuaÃ§Ã£o da Semana", allScores.weekly],
Â  Â  Â  Â  Â  Â  Â  Â  ["PontuaÃ§Ã£o do MÃªs", allScores.monthly],
Â  Â  Â  Â  Â  Â  Â  Â  ["PontuaÃ§Ã£o Geral", allScores.total],
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  const ws = XLSX.utils.aoa_to_sheet(data);
Â  Â  Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, "Resumo");
Â  Â  Â  Â  Â  Â  XLSX.writeFile(wb, `resumo_detalhado_${selectedParticipant}_${getFormattedDateKey(selectedDate)}.xls`);
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById('close-summary-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  summaryModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  setupScreen.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  mainApp.classList.add('hidden');
Â  Â  Â  Â  Â  Â  setupDate.value = '';
Â  Â  Â  Â  Â  Â  setupParticipant.value = '';
Â  Â  Â  Â  Â  Â  confirmDetails.classList.add('hidden');
Â  Â  Â  Â  Â  Â  confirmBtn.disabled = true;
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- LÃ“GICA DE SETUP E EVENTOS ---
Â  Â  Â  Â  const checkSetupValidity = () => {
Â  Â  Â  Â  Â  Â  const dateVal = setupDate.value;
Â  Â  Â  Â  Â  Â  const participantVal = setupParticipant.value;
Â  Â  Â  Â  Â  Â  if (dateVal && participantVal) {
Â  Â  Â  Â  Â  Â  Â  Â  const selectedDate = new Date(dateVal + 'T12:00:00');
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedDate < challengeStartDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('A data nÃ£o pode ser anterior ao inÃ­cio do desafio.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmDetails.classList.add('hidden'); return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  state.selectedDate = selectedDate;
Â  Â  Â  Â  Â  Â  Â  Â  state.selectedParticipant = participantVal;
Â  Â  Â  Â  Â  Â  Â  Â  confirmName.textContent = participantVal;
Â  Â  Â  Â  Â  Â  Â  Â  confirmDate.textContent = selectedDate.toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  Â  Â  confirmDetails.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.disabled = false;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  confirmDetails.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  setupDate.addEventListener('change', checkSetupValidity);
Â  Â  Â  Â  setupParticipant.addEventListener('change', checkSetupValidity);

Â  Â  Â  Â  confirmBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  setupScreen.classList.add('hidden');
Â  Â  Â  Â  Â  Â  mainApp.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('current-participant-name').textContent = state.selectedParticipant;
Â  Â  Â  Â  Â  Â  document.getElementById('current-checkin-date').textContent = state.selectedDate.toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  const dateKey = getFormattedDateKey(state.selectedDate);
Â  Â  Â  Â  Â  Â  const participantLogs = state.allData[state.selectedParticipant]?.dailyLogs || {};
Â  Â  Â  Â  Â  Â  if (participantLogs[dateKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  checkinForm.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Check-in para este dia jÃ¡ foi realizado.', 'error');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â checkinForm.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â checkinForm.reset();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateLeaderboardUI();
Â  Â  Â  Â  });

Â  Â  Â  Â  checkinForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  confirmBtn.disabled = true;
Â  Â  Â  Â  Â  Â  confirmBtn.textContent = "A Guardar...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dateKey = getFormattedDateKey(state.selectedDate);
Â  Â  Â  Â  Â  Â  const inputs = {
Â  Â  Â  Â  Â  Â  Â  Â  aerobicMinutes: Number(document.getElementById('aerobic-minutes').value) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  strengthSessions: Number(document.getElementById('strength-sessions').value) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  fruitPortions: document.querySelectorAll('input[name="fruit-meal"]:checked').length,
Â  Â  Â  Â  Â  Â  Â  Â  hydration: document.getElementById('hydration').checked,
Â  Â  Â  Â  Â  Â  Â  Â  noSweets: document.getElementById('no-sweets').checked,
Â  Â  Â  Â  Â  Â  Â  Â  sleep: document.getElementById('sleep').checked,
Â  Â  Â  Â  Â  Â  Â  Â  selfCareActivities: Array.from(document.querySelectorAll('input[name="selfcare-activity"]:checked')).map(el => el.value)
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const participantRef = doc(state.db, `artifacts/${state.appId}/public/data/healthChallenge`, state.selectedParticipant);
Â  Â  Â  Â  Â  Â  Â  Â  const currentData = state.allData[state.selectedParticipant] || { dailyLogs: {} };
Â  Â  Â  Â  Â  Â  Â  Â  currentData.dailyLogs[dateKey] = { inputs };
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(participantRef, currentData);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Check-in guardado com sucesso!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showSummary();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao guardar no Firestore:", error);
Â  Â  Â  _message('Erro ao guardar os dados. Tente novamente.', 'error');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.textContent = "Confirmar e Continuar";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- INICIALIZAÃ‡ÃƒO ---
Â  Â  Â  Â  const init = async () => {
Â  Â  Â  Â  Â  Â  if (new Date() < challengeStartDate) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('app-container').innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-md"><h1 class="text-2xl font-bold text-teal-600">O Desafio ainda nÃ£o comeÃ§ou!</h1><p class="mt-2">Volte em ${challengeStartDate.toLocaleDateString('pt-BR')}.</p></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Use as variÃ¡veis globais fornecidas pelo ambiente
Â  Â  Â  Â  Â  Â  Â  Â  const firebaseConfig = JSON.parse(__firebase_config);
Â  Â  Â  Â  Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  Â  Â  Â  Â  state.db = getFirestore(app);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // LÃ³gica de autenticaÃ§Ã£o corrigida
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInWithCustomToken(auth, __initial_auth_token);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const collectionRef = collection(state.db, `artifacts/${state.appId}/public/data/healthChallenge`);
Â  Â  Â  Â  Â  Â  Â  Â  onSnapshot(collectionRef, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snapshot.docs.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.allData[doc.id] = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('main-app').classList.contains('hidden') === false) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â updateLeaderboardUI();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro no listener do Snapshot:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Erro ao carregar dados em tempo real.", "error");
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  setupParticipant.innerHTML = '<option value="">-- Selecione --</option>' + participants.map(p => `<option value="${p}">${p}</option>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  populateChecklists();
Â  Â  Â  Â  Â  Â  Â  Â  loadingScreen.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  setupScreen.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro na inicializaÃ§Ã£o do Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  loadingScreen.innerHTML = `<p class="text-red-500">Erro ao ligar com o servidor. Verifique a consola para mais detalhes.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  init();
Â  Â  </script>
</body>
</ht
